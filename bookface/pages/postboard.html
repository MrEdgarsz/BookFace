{% extends "base.html" %}
{% block title %}
Post Board
{% endblock %}

{% block content %}
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/postboard.css') }}">
    {% with messages = get_flashed_messages(with_categories=true) %}
    <div class="container">
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }} 
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
    {% endwith %}
    {% include "includes/global/components/button_scroll_to_top.html" %}
    {% include "includes/postboard/forms/add_post_form.html" %}
    <hr class="bg-primary border-2 border-top border-primary"></hr>
    {% for post in posts %}
    {% include "includes/postboard/modals/block_user_modal.html" %}
    {% include "includes/postboard/modals/unblock_user_modal.html" %}
    {% include "includes/postboard/modals/remove_post_modal.html" %}
    {% include "includes/postboard/modals/edit_post_modal.html" %}    
        <div class="card-deck">
            <div class="card post">
                <div class="card-header post-header">
                    <div class="post-info">
                        <img src="{{ url_for('static', filename='images/default_avatar.png') }}" class="user-avatar">
                        <div class="post-info-user">
                            <p class="card-title post-info-user-name">
                                {% if post.user.role.id != 4 %}
                                <b>{{ post.user.username }}</b>
                                {% else %}
                                <b class="text-muted">{{ post.user.username }}</b>
                                {% endif %}
                                {% if post.user.role.id != 3 %}
                                <small>[{{ post.user.role.name }}]</small>
                                {% endif %}    
                            </p>
                            <div>
                                <small class="card-subtitle text-muted" data-bs-toggle="tooltip" title="{{ post.created_at.strftime('%d.%m.%Y %H:%M') }}">
                                    {{ post.get_time_difference() }}
                                </small>
                                {% if post.updated_at != post.created_at %}
                                <small class="card-subtitle text-muted" data-bs-toggle="tooltip" title="{{ post.updated_at.strftime('%d.%m.%Y %H:%M') }}">
                                    · edytowany
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        {% if current_user.id != post.user.id %}
                        <div class="btn-group post-options-btn" role="group">
                            <button class="btn btn-sm dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                                </svg>
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="postOptions">
                                <li>
                                    <button type="button" class="btn btn-sm dropdown-item" data-bs-toggle="modal" data-bs-target="#editPost-{{ post.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                                            <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"/>
                                        </svg>
                                        Edytuj post
                                    </button>
                                </li>
                                {% if post.user.role.id != 4 %}
                                <li>
                                    {% if post.user.role.id == 2 %}
                                    <button type="button" class="btn btn-sm dropdown-item" data-bs-toggle="modal" data-bs-target="#blockUser-{{ post.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16">
                                            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                            <path fill-rule="evenodd" d="M12.146 5.146a.5.5 0 0 1 .708 0L14 6.293l1.146-1.147a.5.5 0 0 1 .708.708L14.707 7l1.147 1.146a.5.5 0 0 1-.708.708L14 7.707l-1.146 1.147a.5.5 0 0 1-.708-.708L13.293 7l-1.147-1.146a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                        Zabierz uprawienia
                                    </button>
                                    {% else %}
                                    <button type="button" class="btn btn-sm dropdown-item" data-bs-toggle="modal" data-bs-target="#blockUser-{{ post.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-x" viewBox="0 0 16 16">
                                            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                            <path fill-rule="evenodd" d="M12.146 5.146a.5.5 0 0 1 .708 0L14 6.293l1.146-1.147a.5.5 0 0 1 .708.708L14.707 7l1.147 1.146a.5.5 0 0 1-.708.708L14 7.707l-1.146 1.147a.5.5 0 0 1-.708-.708L13.293 7l-1.147-1.146a.5.5 0 0 1 0-.708z"/>
                                        </svg>
                                        Zablokuj użytkownika
                                    </button>
                                    {% endif %}
                                </li>
                                {% else %}
                                <li>
                                    <button type="button" class="btn btn-sm dropdown-item" data-bs-toggle="modal" data-bs-target="#unblockUser-{{ post.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-check" viewBox="0 0 16 16">
                                            <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0zm4 8c0 1-1 1-1 1H1s-1 0-1-1 1-4 6-4 6 3 6 4zm-1-.004c-.001-.246-.154-.986-.832-1.664C9.516 10.68 8.289 10 6 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10z"/>
                                            <path fill-rule="evenodd" d="M15.854 5.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 0 1 .708-.708L12.5 7.793l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                                          </svg>
                                        Odblokuj użytkownika
                                    </button>
                                </li>
                                {% endif %}
                                <li>
                                    <button type="button" class="btn btn-danger btn-sm dropdown-item" data-bs-toggle="modal" data-bs-target="#removePost-{{ post.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                            <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                        </svg>
                                        Usuń post
                                    </button>
                                </li>
                            </ul>
                        </div>
                    {% endif %}    
                    </div>        
                </div>
                <div class="card-body post-content">   
                    <p class="card-text">{{ post.description | safe }}</p>
                    <hr>
                    <p class="card-text">
                        <a href="send_like/{{ post.id}}" class="btn btn-outline-danger" data-bs-toggle="tooltip" data-bs-html="true" title="{% if post.likes == 1 %} Ten post podoba się <b>{{ post.likes }}</b> osobie {% elif post.likes > 1 %} Ten post podoba się <b>{{ post.likes }}</b> osobom {% endif %}">
                            <i class="bi bi-balloon"></i>
                            {% if post.likes > 0 %}
                                {{ post.likes }}
                            {% endif %}
                        </a>
                    </p>
                </div>
            </div>
            <br>
        {% endfor %}
        </div> 
</div>
<!-- TinyMCE  -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.tiny.cloud/1/9ereik6l9j5n7qcn503nt1z19s7udhc57hl17hwtoz2o2eii/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
$(function () {
    $('#postFormTip').hide();

    tinymce.init({
        selector: '#postForm',
        language: 'pl',
        plugins: [
            'lists','link','image','charmap','preview','searchreplace','visualblocks',
            'powerpaste','formatpainter','insertdatetime','media','help','wordcount'
        ],
        init_instance_callback: (editor) => {
            console.log(`Editor: ${editor.id} is now initialized.`);
        },
        setup: function (editor) {
            editor.on('change', function () {
                tinymce.triggerSave();
                checkSubmit();
            });
        }
    });

    tinymce.init({
        selector: '.editPostForm',
        language: 'pl',
        plugins: [
            'lists','link','image','charmap','preview','searchreplace','visualblocks',
            'powerpaste','formatpainter','insertdatetime','media','help','wordcount'
        ],
        init_instance_callback: (editor) => {
            console.log(`Editor: ${editor.id} is now initialized.`);
        },
        setup: function (editor) {
            editor.on('change', function () {
                tinymce.triggerSave();
                checkEditSubmit();
            });
        }
    });

    $(document).on('click', '#postFormSubmit', checkSubmit);	
    function checkSubmit() {
        var editorValue = $('#postForm').val();
        var textEditorValue = $.trim($(editorValue).text());
		
        if (textEditorValue == '') {
            $('#postFormSubmit').prop('disabled', true);
            $('#postFormTip').show();
            $('#postFormTip').html('Aby zamieścić post na tablicy, należy najpierw wypełnić powyższy formularz.');
            return false;
        }
        else {
            $('#postFormSubmit').prop('disabled', false);
            $('#postFormTip').hide();
            $('#postFormTip').html('');
            return true;
        }
    }
});
</script>
{% endblock %}   